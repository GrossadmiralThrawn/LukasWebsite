<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" th:href="@{/styles.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body class="dark-mode">
<h1>Dashboard</h1>

<div>
    <h2>Systeminformationen</h2>
    <canvas id="cpuChart" width="400" height="200"></canvas>
    <canvas id="ramChart" width="400" height="200"></canvas>
</div>

<div>
    <h2>Statistiken</h2>
    <p>Anzahl der Aufrufe in der letzten Woche: <span th:text="${lastWeekStatistics}">0</span></p>
</div>

<div>
    <h2>Aufrufe der letzten 7 Tage</h2>
    <canvas id="requestChart" width="400" height="200"></canvas>
</div>

<!-- Der Button hat jetzt eine spezielle Klasse "dashboard-button" -->
<button class="button button-large dashboard-button" onclick="window.location.href='/user/statistics'">Statistiken</button>

<script>
    let cpuChart, ramChart, requestChart;

    $(document).ready(function() {
        const ctxCpu = document.getElementById('cpuChart').getContext('2d');
        cpuChart = new Chart(ctxCpu, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'CPU-Auslastung (%)',
                    data: [],
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1,
                    fill: true
                }]
            },
            options: {
                scales: {
                    y: { beginAtZero: true, max: 100 }
                }
            }
        });

        const ctxRam = document.getElementById('ramChart').getContext('2d');
        ramChart = new Chart(ctxRam, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'RAM-Auslastung (%)',
                    data: [],
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1,
                    fill: true
                }]
            },
            options: {
                scales: {
                    y: { beginAtZero: true, max: 100 }
                }
            }
        });

        const ctxRequest = document.getElementById('requestChart').getContext('2d');
        requestChart = new Chart(ctxRequest, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Anzahl der Aufrufe',
                    data: [],
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            callback: function(value) {
                                if (Number.isInteger(value)) {
                                    return value;
                                }
                            }
                        }
                    }
                }
            }
        });

        setInterval(fetchAndUpdateSystemData, 600);

        fetchAndDisplayRequestData();
    });

    function fetchAndUpdateSystemData() {
        $.ajax({
            url: '/user/systemData',
            method: 'GET',
            success: function(data) {
                const currentTime = new Date().toLocaleTimeString();

                if (cpuChart.data.labels.length >= 10) {
                    cpuChart.data.labels.shift();
                    cpuChart.data.datasets[0].data.shift();
                }
                cpuChart.data.labels.push(currentTime);
                cpuChart.data.datasets[0].data.push(data.cpuUsage);
                cpuChart.update();

                if (ramChart.data.labels.length >= 10) {
                    ramChart.data.labels.shift();
                    ramChart.data.datasets[0].data.shift();
                }
                ramChart.data.labels.push(currentTime);
                ramChart.data.datasets[0].data.push(data.ramUsage);
                ramChart.update();
            }
        });
    }

    function fetchAndDisplayRequestData() {
        $.ajax({
            url: '/user/statisticsData',
            method: 'GET',
            success: function(data) {
                const labels = Object.keys(data);
                const values = Object.values(data);

                requestChart.data.labels = labels;
                requestChart.data.datasets[0].data = values;
                requestChart.update();
            }
        });
    }
</script>
</body>
</html>
